@startuml Estructura - Mapa de Archivos

!define MODEL_COLOR #E8F4FD
!define ENGINE_COLOR #FDF2E9
!define SCHED_COLOR #E8F8F5
!define IO_COLOR #F3E5F5
!define METRICS_COLOR #EBF5FB
!define GANTT_COLOR #FADBD8
!define STORES_COLOR #FDEAA7
!define ROUTES_COLOR #D5E8D4
!define TEST_COLOR #FFF2CC

skinparam shadowing false
skinparam defaultTextAlignment left
skinparam packageStyle rectangle
skinparam ArrowColor #666666
skinparam PackageBorderColor #999999
skinparam RectangleBorderColor #BBBBBB
skinparam NoteBackgroundColor #FFFEF5
skinparam NoteBorderColor #E6D8A8
skinparam minClassWidth 180
skinparam maxMessageSize 150
skinparam nodesep 20
skinparam ranksep 30
hide circle

title Proyecto Simulador de Planificación – Mapa de Archivos

package "src" as SRC {

  package "lib" as LIB {

      package "model" as MODEL {
        rectangle "proceso.ts" as proceso_ts
        rectangle "rafaga.ts" as rafaga_ts
        rectangle "estados.ts" as estados_ts
        rectangle "costos.ts" as costos_ts
        
        proceso_ts -[hidden]down-> rafaga_ts
        rafaga_ts -[hidden]down-> estados_ts
        estados_ts -[hidden]down-> costos_ts

        note right of proceso_ts
          **✓ Implementado**
          • Tipos de Proceso (pid, arribo, ráfagas)
          • Estado del proceso (N, L, C, B, F)
          • servicioTotal() - suma de ráfagas CPU
          • isProcesoValido() - validación básica
        end note

        note right of rafaga_ts
          **✓ Implementado**
          • Utilidades para manejar rafagas
          • Índice/actual y chequeos de restantes
          • rafagaActual() - obtiene ráfaga por índice
          • quedanRafagas() - verifica ráfagas restantes
        end note

        note right of estados_ts
          **✓ Implementado**
          • Definición de estados
          • Reglas de transición válidas (invariantes)
          • Estados canónicos (N,L,C,B,F)
          • isTransicionLegal() - validador de transiciones
          • assertTransicionLegal() - error si ilegal
          • transicionarEstado() - transición inmutable
        end note

        note right of costos_ts
          **✓ Implementado**
          • Interface Costos (TIP, TCP, TFP, bloqueoES)
          • COSTOS_DEF - defaults (bloqueoES=25)
          • validarCostos() - verifica valores ≥ 0
          • makeCostos() - constructor saneado
        end note
      }

      package "engine" as ENGINE {
        rectangle "types.ts" as engine_types_ts
        rectangle "queue.ts" as queue_ts
        rectangle "engine.ts" as engine_ts
        
        engine_types_ts -[hidden]down-> queue_ts
        queue_ts -[hidden]down-> engine_ts

        note right of engine_types_ts
          **✓ Implementado**
          • Tipos del motor (EventType, SimEvent)
          • Estructura de traza (slices, eventos)
          • Contratos de entrada/salida de run()
        end note

        note right of queue_ts
          **✓ Implementado**
          • Cola de eventos
          • Orden por timestamp + prioridad de evento
        end note

        note right of engine_ts
          **✓ Implementado** <<mod - Paso 5>>
          • runFCFSSandbox() - motor FCFS completo
          • Guard anti-doble-dispatch por tick
          • Estado runtime por proceso (idxRafaga, restante)
          • Costos TIP/TCP/TFP: gatillo release+despacho
          • TFP no bloquea CPU (liberación en tFinCPU)
          • Bloqueos E/S: B→L @ t+bloqueoES (default 25ms)
          • Construcción de traza (slices + events)
        end note
      }

      package "scheduler" as SCHED {
        rectangle "scheduler.ts" as scheduler_ts
        rectangle "ready-queue.ts" as ready_queue_ts
        rectangle "fcfs.ts" as fcfs_ts
        rectangle "rr.ts" as rr_ts
        rectangle "spn.ts" as spn_ts
        rectangle "srtn.ts" as srtn_ts
        rectangle "priority.ts" as priority_ts
        
        scheduler_ts -[hidden]down-> ready_queue_ts
        ready_queue_ts -[hidden]down-> fcfs_ts
        fcfs_ts -[hidden]down-> rr_ts
        rr_ts -[hidden]down-> spn_ts
        spn_ts -[hidden]down-> srtn_ts
        srtn_ts -[hidden]down-> priority_ts

        note right of scheduler_ts
          **✓ Implementado**
          • IScheduler - interfaz completa de planificadores
          • BaseScheduler - clase base abstracta
          • Métodos: onAdmit, onReady, onBlock, onFinish, next()
        end note

        note right of ready_queue_ts
          **✓ Implementado**
          • ReadyQueue - cola FIFO simple
          • Métodos: enqueue, dequeue, isEmpty, clear, toArray
          • Manejo de PIDs en orden de llegada
        end note

        note right of fcfs_ts
          **✓ Implementado**
          • SchedulerFCFS - First Come First Served
          • Extiende BaseScheduler
          • Política no expropiativa (FIFO puro)
          • Integrado con motor sandbox
        end note

        note right of rr_ts
          **⏳ Pendiente**
          • Planificador Round Robin
          • Manejo de quantum y reencolado
        end note

        note right of spn_ts
          **⏳ Pendiente**
          • Planificador SPN (no expropiativo)
          • Selección por ráfaga más corta siguiente
        end note

        note right of srtn_ts
          **⏳ Pendiente**
          • Planificador SRTN (expropiativo)
          • Selección por menor tiempo restante
        end note

        note right of priority_ts
          **⏳ Pendiente**
          • Planificador por prioridades
          • (Opcional) Envejecimiento/ajuste de prioridad
        end note
      }

      package "io" as IO {
        rectangle "parser.ts" as parser_ts
        rectangle "export.ts" as export_ts
        
        parser_ts -[hidden]down-> export_ts

        note right of parser_ts
          **⏳ Pendiente**
          • Validación y normalización de entrada (JSON/CSV)
          • Conversión a estructuras de Proceso
        end note

        note right of export_ts
          **⏳ Pendiente**
          • Exportación de trazas/métricas (JSON/CSV)
          • Helpers para descarga/serialización
        end note
      }

      package "metrics" as METRICS {
        rectangle "metricas.ts" as metricas_ts
        note right of metricas_ts
          **⏳ Pendiente**
          • Cálculo de métricas por proceso y globales
          • TRp, TE, TRn, promedios y agregados
        end note
      }

      package "gantt" as GANTT {
        rectangle "schema.ts" as schema_ts
        rectangle "builder.ts" as builder_ts
        
        schema_ts -[hidden]down-> builder_ts

        note right of schema_ts
          **⏳ Pendiente**
          • Tipos para el modelo de Gantt de UI
          • Items, inicio/fin y normalizaciones
        end note

        note right of builder_ts
          **⏳ Pendiente**
          • Conversión de trace.slices a modelo de Gantt
          • Agrupación y orden cronológico para pintar
        end note
      }
    

    package "stores" as STORES {
      rectangle "simulacion.ts" as simulacion_store_ts
      note right of simulacion_store_ts
        **⏳ Pendiente**
        • Svelte stores para política seleccionada
        • Resultados (trace/fin) y costos en UI
      end note
    }

    package "test" as TEST {
      rectangle "test-paso1-modelo.ts" as test_paso1_ts
      rectangle "test-paso2-engine.ts" as test_paso2_ts
      rectangle "test-fcfs-sandbox.ts" as test_fcfs_sandbox_ts
      rectangle "debug-golden-b.ts" as debug_golden_b_ts
      rectangle "test-motor-completo.ts" as test_motor_completo_ts
      rectangle "test-paso4-bloqueos.ts" as test_paso4_bloqueos_ts
      rectangle "test-paso5-costos.ts" as test_paso5_costos_ts
      rectangle "test-paso5-complejo.ts" as test_paso5_complejo_ts
      
      test_paso1_ts -[hidden]down-> test_paso2_ts
      test_paso2_ts -[hidden]down-> test_fcfs_sandbox_ts
      test_fcfs_sandbox_ts -[hidden]down-> debug_golden_b_ts
      debug_golden_b_ts -[hidden]down-> test_motor_completo_ts
      test_motor_completo_ts -[hidden]down-> test_paso4_bloqueos_ts
      test_paso4_bloqueos_ts -[hidden]down-> test_paso5_costos_ts
      test_paso5_costos_ts -[hidden]down-> test_paso5_complejo_ts

      note right of test_paso1_ts
        **✓ Implementado**
        • Tests de aceptación del Paso 1
        • Validación de servicioTotal, transiciones
        • Verificación de costos y validaciones
      end note

      note right of test_paso2_ts
        **✓ Implementado**
        • Tests de aceptación del Paso 2
        • Validación de cola de eventos
        • Verificación de tipos del motor
      end note

      note right of test_fcfs_sandbox_ts
        **✓ Implementado**
        • Validación de Golden Cases A y B
        • Test de motor FCFS sandbox básico
        • Verificación de slices esperados
      end note

      note right of debug_golden_b_ts
        **✓ Implementado**
        • Debug detallado del Golden B
        • Análisis de eventos paso a paso
        • Verificación de anti-doble-dispatch
      end note

      note right of test_motor_completo_ts
        **✓ Implementado**
        • Test comprensivo del motor FCFS
        • Validación de múltiples casos de prueba
        • Documentación de comportamiento esperado
      end note

      note right of test_paso4_bloqueos_ts
        **✓ Implementado** <<Paso 4>>
        • Gate test con bloqueoES=25ms
        • Validación de latencia E/S correcta
        • Verificación "B→L no consume CPU"
        • Confirmación de tiempos de bloqueo
      end note

      note right of test_paso5_costos_ts
        **✓ Implementado** <<Paso 5>>
        • Gate test TIP=1, TCP=1, TFP=1
        • Validación modelo estricto: P1: 2–7, P2: 8–12
        • Verificación duraciones inalteradas
        • Confirmación TFP no bloquea CPU
      end note

      note right of test_paso5_complejo_ts
        **✓ Implementado** <<Paso 5>>
        • Caso complejo: costos + E/S combinados
        • Múltiples slices con TIP/TCP/TFP
        • Validación orden temporal correcto
        • Verificación liberación CPU en tFinCPU
      end note
    }
  }

  package "routes" as ROUTES {
    rectangle "+layout.svelte" as layout_svelte
    rectangle "+page.svelte" as main_page

    package "simulacion" as R_SIM {
      rectangle "+page.svelte" as simulacion_page
    }
    
    package "resultados" as R_RES {
      rectangle "+page.svelte" as resultados_page
    }
    
    layout_svelte -[hidden]down-> main_page
    main_page -[hidden]down-> R_SIM
    R_SIM -[hidden]down-> R_RES

    note right of layout_svelte
      **⏳ Pendiente**
      • Layout general, estilos, navigation shell
    end note

    note right of main_page
      **⏳ Pendiente**
      • Página principal del simulador
      • Landing page y navegación
    end note

    note right of simulacion_page
      **⏳ Pendiente**
      • Pantalla para cargar tanda y ejecutar simulación
      • UI de selección de política y parámetros
      • Vista de métricas y Gantt básicos
    end note

    note right of resultados_page
      **⏳ Pendiente**
      • Visualización de resultados finales
      • Botones de exportación (JSON/CSV)
    end note
  }

  rectangle "app.d.ts" as app_dts
  note right of app_dts
    **⏳ Pendiente**
    • Tipos globales para SvelteKit/ambient
    • Extensiones de App namespace (si las hay)
  end note
}

MODEL -[hidden]down-> ENGINE
ENGINE -[hidden]down-> SCHED
SCHED -[hidden]down-> IO
IO -[hidden]down-> METRICS
METRICS -[hidden]down-> GANTT
GANTT -[hidden]down-> STORES
STORES -[hidden]down-> TEST
TEST -[hidden]down-> ROUTES

' Motor y tipos
engine_ts --> engine_types_ts : usa tipos
engine_ts --> queue_ts : utiliza cola
engine_ts --> fcfs_ts : usa SchedulerFCFS
engine_ts --> proceso_ts : lee modelo
engine_ts --> costos_ts : aplica costos

' Planificadores y cola
scheduler_ts --> ready_queue_ts : usa ReadyQueue
fcfs_ts --> scheduler_ts : extiende BaseScheduler
fcfs_ts --> ready_queue_ts : hereda uso
rr_ts --> ready_queue_ts
spn_ts --> ready_queue_ts
srtn_ts --> ready_queue_ts
priority_ts --> ready_queue_ts

' Tests y motor
test_fcfs_sandbox_ts --> engine_ts : prueba runFCFSSandbox
debug_golden_b_ts --> engine_ts : debug motor
test_motor_completo_ts --> engine_ts : test comprensivo

' Gantt y esquemas
builder_ts --> schema_ts

' UI y lógica
simulacion_page --> simulacion_store_ts
simulacion_page --> engine_ts
simulacion_page --> builder_ts
simulacion_page --> metricas_ts
resultados_page --> export_ts

' Parser y modelo
parser_ts --> proceso_ts

' ----------------------------------------------------------
legend bottom
**Convenciones del Diagrama**
• Cada rectángulo = archivo físico
• Las notas indican "qué contiene" y estado actual
• Las flechas muestran dependencias principales (informativas)

**Estados de implementación:**
• **✓ Implementado** - Código completo y testeado (Golden Cases validados)
• **⏳ Pendiente** - Archivos creados, pendiente implementación

**Cambios (Paso 6):**
• scheduler/rr.ts <<nuevo>>: RR con quantum, re-encolado en desalojo
• engine.ts <<mod>>: programar C→L @ t_s+q; empates fin ráfaga > timer;
                     handler C→L actualiza r.restante y re-encola

**Colores por Módulo:**
• **model** - Tipos y entidades base
• **engine** - Motor de simulación  
• **scheduler** - Algoritmos de planificación
• **io** - Entrada/salida de datos
• **metrics** - Cálculo de métricas
• **gantt** - Generación de diagramas
• **stores** - Estado de aplicación
• **routes** - Páginas de la aplicación
• **test** - Tests de aceptación
endlegend

@enduml
